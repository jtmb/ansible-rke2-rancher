- name: Download and install Helm
  shell: |
    curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
    chmod 700 get_helm.sh
    ./get_helm.sh
  tags: [rancher_dashboard]

- name: Add Rancher Helm repository
  shell: helm repo add rancher-stable https://releases.rancher.com/server-charts/stable
  tags: [rancher_dashboard]

- name: Wait for node to be Ready
  shell: |
    export KUBECONFIG=/etc/rancher/rke2/rke2.yaml
    until /var/lib/rancher/rke2/bin/kubectl get nodes | grep " Ready "; do sleep 5; done
  tags: [rancher_dashboard]

- name: Create Rancher namespace
  shell: |
    export KUBECONFIG=/etc/rancher/rke2/rke2.yaml
    /var/lib/rancher/rke2/bin/kubectl create namespace cattle-system
  tags: [rancher_dashboard]

- name: Install Rancher via Helm
  shell: |
    export KUBECONFIG=/etc/rancher/rke2/rke2.yaml
    helm install rancher rancher-stable/rancher \
      --namespace cattle-system \
      --create-namespace \
      --set hostname={{ hostname }} \
      --set bootstrapPassword=admin \
      --set ingress.tls.source=none
  tags: [rancher_dashboard]